# äº‹ä»¶å¾ªç¯

1. æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹
  - GUI æ¸²æŸ“çº¿ç¨‹: æ¸²æŸ“å’Œè§£æé¡µé¢
  - JS å¼•æ“çº¿ç¨‹: æ¸²æŸ“å’Œè§£æ JS ä»£ç  æµè§ˆå™¨åˆ†é…çš„ä¸€ä¸ªçº¿ç¨‹å»è§£æ JS æ‰€ä»¥ JS æ˜¯å•çº¿ç¨‹
  - å®šæ—¶å™¨ç›‘å¬çº¿ç¨‹
  - äº‹ä»¶ç›‘å¬çº¿ç¨‹
  - HTTP ç½‘ç»œè¯·æ±‚çº¿ç¨‹ [åŒæºä¸‹, æµè§ˆå™¨æœ€å¤šåŒæ—¶åˆ†é…5~7ä¸ª HTTP çº¿ç¨‹]

JS æ˜¯å•çº¿ç¨‹è¿è¡Œçš„,å¤§éƒ¨åˆ†çš„ä»£ç éƒ½æ˜¯ åŒæ­¥ "è¿è¡Œ" çš„

2. ç”±äºJSæ‰§è¡Œæ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„, æ„å‘³ç€åŒæ„æ—¶é—´å†…åªèƒ½æ‰§è¡Œä¸€ä¸ªäº‹ä»¶, ä½†å•çº¿ç¨‹å¹¶ä¸æ„å‘³ç€é˜»å¡, é€šè¿‡äº‹ä»¶å¾ªç¯è§£å†³å¯ä»¥å®ç°å•çº¿ç¨‹ä¸é˜»å¡.

3. äº‹ä»¶å¾ªç¯çš„ç¯å¢ƒ æµè§ˆå™¨ç¯å¢ƒ, NODE ç¯å¢ƒ.

åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹
äº‹ä»¶å¾ªç¯å¯ä»¥ç†è§£ä¸º, JS ä»£ç å’Œ æµè§ˆå™¨API(setTimeout/AJAX/ç›‘å¬äº‹ä»¶)è°ƒç”¨æ²Ÿé€šçš„ä¸€ä¸ªæ¡¥æ¢,é€šè¿‡å›è°ƒå‡½æ•°æ¥æ‰§è¡Œ.

åœ¨ NODE ç¯å¢ƒä¸‹
äº‹ä»¶å¾ªç¯å¯ä»¥ç†è§£ä¸º, JS ä»£ç å’Œ NODE ç³»ç»Ÿè°ƒç”¨(file System, network) æ²Ÿé€šçš„ä¸€ä¸ªæ¡¥æ¢.é€šè¿‡å›è°ƒå‡½æ•°æ¥æ‰§è¡Œ.


## äº‹ä»¶å¾ªç¯æ‰§è¡Œæµç¨‹

1. æµè§ˆå™¨åŠ è½½é¡µé¢, é™¤äº†å¼€è¾Ÿå †æ ˆå†…å­˜ä¹‹å¤–,è¿˜åˆ›å»ºäº†ä¸¤ä¸ªé˜Ÿåˆ—

		-  WebAPI: ä»»åŠ¡ç›‘å¬é˜Ÿåˆ—
		-  EventQueue: äº‹ä»¶/ä»»åŠ¡é˜Ÿåˆ—

âœ¨ç¬¬ä¸€æ­¥: åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç çš„åŒæ—¶, é‡åˆ°äº† "å¼‚æ­¥ä»£ç " åœ¨åˆé€‚çš„æ—¶æœºå°†å¼‚æ­¥ä»»åŠ¡æ”¾å…¥WebAPI ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…å›è°ƒä½¿ç”¨.
è¿™æ ·ä¸»çº¿ç¨‹çš„ä»»åŠ¡å°±ä¸ä¼šè¢«é˜»å¡,ç»§ç»­æ‰§è¡Œä¸»çº¿ç¨‹çš„åŒæ­¥ä»£ç .

ğŸ«¡ç¬¬äºŒæ­¥: å½“å¼‚æ­¥ä»»åŠ¡è¢«æ£€æµ‹åˆ°å¯ä»¥æ‰§è¡Œäº†ä¼šè¢«åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ EventQueue ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œ.
  + æ ¹æ®å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡,æ”¾åœ¨ä¸åŒçš„é˜Ÿåˆ—

ğŸŒ°eg: åœ¨ä»£ç ä¸­è®¾ç½®ä¸€ä¸ª 3sçš„å®šæ—¶å™¨, ä¼šè°ƒç”¨WebAPI,è®¡æ—¶ 3s. å½“æ—¶é—´åˆ°äº†ä¹‹å,æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—.ç­‰å¾…æ‰§è¡Œ.å› æ­¤å®šæ—¶å™¨å¹¶ä¸å‡†.

ç¬¬ä¸‰æ­¥: å½“ä¸»çº¿ç¨‹çš„åŒæ­¥ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œäº†ä¹‹å,ä¸»çº¿ç¨‹ç©ºé—²,ä¼šå»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºå¼‚æ­¥ä»»åŠ¡ å¹¶å¼€å§‹åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ.æ‰§è¡Œå®Œäº†ä¹‹åç»§ç»­å›åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­å–å¼‚æ­¥ä»»åŠ¡,ç›´è‡³å…¨éƒ¨æ‰§è¡Œå®Œ.

  äº‹ä»¶é˜Ÿåˆ—ä¸­å­˜æ”¾ç€å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡,å¼‚æ­¥å¾®ä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å®ä»»åŠ¡çš„è¦é«˜,ä¸è®ºå…¶ä»»åŠ¡æ˜¯å…ˆæ”¾å…¥é˜Ÿåˆ—è¿˜æ˜¯åæ”¾å…¥é˜Ÿåˆ—çš„,å…ˆæ‰§è¡Œå¾®ä»»åŠ¡,ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œäº†ä¹‹ååœ¨æ‰§è¡Œäº‹ä»¶é˜Ÿåˆ—ä¸­çš„å®ä»»åŠ¡.

è¿™å°±æ˜¯äº‹ä»¶å¾ªç¯æœºåˆ¶.



![image-20230421144840775](https://cyzblog-1305365553.cos.ap-guangzhou.myqcloud.com/image-20230421144840775.png)

## å¸¸è§çš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡
å®ä»»åŠ¡é˜Ÿåˆ— ( macrotask queue ): ajax, setTimeout, setInterval, DOMç›‘å¬, UI Rendering, setImmediate
å¾®ä»»åŠ¡é˜Ÿåˆ— ( microtask queue ): Promise.then/catch/finally, async/await queueMicrotask process.nextTick(Node)


## ç›¸å…³é¢˜ç›®åˆ†æ

```js
// å¼‚æ­¥å®ä»»åŠ¡ä»£ç 
setTimeout(function () {
  console.log('set1'); // 6
  new Promise(function (resolve) {
    resolve()
  }).then(function () {
    new Promise(function (resolve) {
      resolve()
    }).then(function () {
      // 8
      console.log("then4");
    });
    // 7
    console.log("then2");
  })
})


new Promise(function (resolve) {
  // åŒæ­¥ä»£ç  1
  console.log('pr1');
  resolve();
}).then(function () {
  console.log("then1"); // å¼‚æ­¥å¾®ä»»åŠ¡ä»£ç  3
})

setTimeout(function () {
  // 9
  console.log("set2");
})
// åŒæ­¥ä»£ç  2
console.log(2);

queueMicrotask(() => {
  // å¼‚æ­¥å¾®ä»»åŠ¡ä»£ç  4
  console.log("queueMicrotask1");
})

new Promise(function (resolve) {
  resolve()
}).then(function () {
  // å¼‚æ­¥å¾®ä»»åŠ¡ä»£ç  5
  console.log("then3");
})

```

é¢˜ç›®åˆ†æ
1. å…ˆæ‰§è¡Œå®Œæ‰€æœ‰çš„ä¸»çº¿ç¨‹ä¸­çš„åŒæ­¥ä»£ç , é‡åˆ° 'å¼‚æ­¥' ä»£ç åŠ å…¥å¯¹åº”çš„é˜Ÿåˆ—ä¸­.
2. åŒæ­¥ä»£ç æ‰§è¡Œå®Œä¹‹åä¼šå»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºå¾®ä»»åŠ¡ä»£ç æ‰§è¡Œ.
3. äº‹ä»¶é˜Ÿåˆ—ä¸­çš„å¼‚æ­¥ä»£ç æ‰§è¡Œå®Œäº†ä¹‹å,åœ¨æ‰§è¡ŒåŒæ­¥ä»£ç .


é¢˜ç›®åˆ†æ 2

```js
async function async1() {
  console.log('async1 start'); // 2
  await async2();
  console.log('async1 end'); // 6
}

// await å…³é”®å­—ç›¸å½“äº new Promise((resolve,reject)=>{å‡½æ•°ä½“})
// è¿™é‡Œ await async2() .then(function (){}) ç›¸å½“äºä¸Šé¢çš„ console.log('async1 end');

async function async2() {
  console.log('async2'); // 3
}

console.log('script start'); // 1

setTimeout(function () {
  console.log('setTimeout'); // 8
}, 0)

async1();

new Promise(function (resolve) {
  console.log('promise1'); // 4
  resolve()
}).then(function () {
  console.log('promise2'); // 7
})

console.log('script end'); // 5

```

é¢˜ç›®åˆ†æ3
```js
let body = document.body
body.addEventListener('click', function () {
  Promise.resolve().then(() => {
    console.log(1);
  })
  console.log(2);
})

body.addEventListener('click', function () {
  Promise.resolve().then(() => {
    console.log(3);
  })
  console.log(4);
})
```

äº‹ä»¶ç›‘å¬æ˜¯ å®ä»»åŠ¡
ç‚¹å‡»ä¹‹å,ç¬¬ä¸€ä¸ªå®ä»»åŠ¡å…ˆè¢«æ‰§è¡Œ, åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ åŒæ—¶è¾“å‡º 2, ä¹‹åé€šè¿‡äº‹ä»¶å¾ªç¯, æ‰§è¡Œ å¾®ä»»åŠ¡ è¾“å‡º 1
ä¹‹åå†æ‰§è¡Œç¬¬äºŒä¸ªå®ä»»åŠ¡ åŒç†è¾“å‡º 4 3


## Node ç¯å¢ƒä¸‹çš„ äº‹ä»¶å¾ªç¯

äº‹ä»¶å¾ªç¯æ˜¯ Node.js å¤„ç†éé˜»å¡ I/O æ“ä½œçš„æœºåˆ¶â€”â€”å°½ç®¡ JavaScript æ˜¯å•çº¿ç¨‹å¤„ç†çš„â€”â€”å½“æœ‰å¯èƒ½çš„æ—¶å€™ï¼Œå®ƒä»¬ä¼šæŠŠæ“ä½œè½¬ç§»åˆ°ç³»ç»Ÿå†…æ ¸ä¸­å»ã€‚

å› ä¸ºç›®å‰å¤§å¤šæ•°å†…æ ¸éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥åœ¨åå°å¤„ç†å¤šç§æ“ä½œã€‚å½“å…¶ä¸­çš„ä¸€ä¸ªæ“ä½œå®Œæˆçš„æ—¶å€™ï¼Œå†…æ ¸é€šçŸ¥ Node.js å°†é€‚åˆçš„å›è°ƒå‡½æ•°æ·»åŠ åˆ° è½®è¯¢ é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶æœºæ‰§è¡Œ.

### éé˜»å¡IO å’Œé˜»å¡ IO

åœ¨ Node ç¯å¢ƒä¸‹ JavaScript ä½¿ç”¨ Node fileSystem æä¾›çš„ API æ“ä½œæ–‡ä»¶ æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨æ¥å®ç°çš„.

æ“ä½œç³»ç»Ÿæä¾›äº†ä¸¤ç§è°ƒç”¨æ–¹å¼, é˜»å¡å¼ç³»ç»Ÿè°ƒç”¨å’Œéé˜»å¡å¼ç³»ç»Ÿè°ƒç”¨

- é˜»å¡å¼ç³»ç»Ÿè°ƒç”¨: çº¿ç¨‹å¤„äºé˜»å¡æ€, cpu ä¸ä¼šåˆ†é…æ—¶é—´ç‰‡, éœ€è¦ç­‰å¾…æ­¤çº¿ç¨‹çš„ä»£ç æ‰§è¡Œç»“æŸåæ‰ä¼šç»§ç»­æ‰§è¡Œ.
- éé˜»å¡å¼ç³»ç»Ÿè°ƒç”¨: è°ƒç”¨çº¿ç¨‹å,ä¸»çº¿ç¨‹ä¸ä¼šåœæ­¢,ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œ,è¿‡ä¸€æ®µæ—¶é—´ååœ¨æŸ¥çœ‹çº¿ç¨‹æ‰§è¡Œæœ‰æ²¡æœ‰è¿”å›ç»“æœ.

åœ¨å¼€å‘ä¸­,ä¸€äº›è€—æ—¶çš„ç³»ç»Ÿè°ƒç”¨,å¯ä»¥ä½¿ç”¨è¿™ç§éé˜»å¡å¼ç³»ç»Ÿè°ƒç”¨.
æ¯”å¦‚æ–‡ä»¶çš„è¯»å–, ç½‘ç»œé€šä¿¡ç­‰

### éé˜»å¡å¼ IOçš„é—®é¢˜
æˆ‘ä»¬éœ€è¦ä¸æ–­çš„å–æ£€æŸ¥çº¿ç¨‹æ‰§è¡Œæ˜¯å¦è¿”å›äº†ç»“æœ.
è¿™ä¸ªä»»åŠ¡éœ€è¦å¼€è¾Ÿä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å®Œæˆ.éœ€è¦éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥ä¸€ä¸‹.è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºè½®è¯¢æ“ä½œ.

libuv æä¾›äº†ä¸€ä¸ªçº¿ç¨‹æ± 

1. çº¿ç¨‹æ± ä¼šè´Ÿè´£ç›¸å…³çš„æ“ä½œ,å¹¶ä¸”ä¼šé€šè¿‡è½®è¯¢æˆ–è€…å…¶ä»–æ–¹å¼ç­‰çº¿ç¨‹è¿”å›çš„ç»“æœ.
2. è·å–åˆ°ç»“æœå, å°±å¯ä»¥å°†å¯¹åº”çš„å›è°ƒå‡½æ•°æ”¾å…¥ äº‹ä»¶ä»»åŠ¡é˜Ÿåˆ—ä¸­.
3. äº‹ä»¶å¾ªç¯å°±å¯ä»¥æ¥ç®¡åç»­çš„å·¥ä½œ.


![image-20230421161955443](https://cyzblog-1305365553.cos.ap-guangzhou.myqcloud.com/image-20230421161955443.png)

libuv ä¸­ä¸»è¦ç»´æŠ¤äº†ä¸€ä¸ª EventLoop å’Œ worker threads çº¿ç¨‹æ± 
EventLoop è´Ÿè´£è°ƒç”¨ç³»ç»Ÿçš„ä¸€äº›å…¶ä»–æ“ä½œ: æ–‡ä»¶IO, Network, child-processes ç­‰

### é˜¶æ®µæ¦‚è¿°
å®šæ—¶å™¨: æ­¤é˜¶æ®µæ‰§è¡Œç”± setTimeout() å’Œ setInterval() æ’åºã€‚
å¾…å¤„ç†å›è°ƒ: æ‰§è¡Œ I/O å›è°ƒæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯ è¿­ä»£ã€‚
ç©ºé—², å‡†å¤‡: ä»…åœ¨å†…éƒ¨ä½¿ç”¨ã€‚
è°ƒæŸ¥: æ£€ç´¢æ–°çš„ I/O äº‹ä»¶; æ‰§è¡Œ I/O ç›¸å…³å›è°ƒ(å‡ ä¹ é™¤äº†å…³é—­å›è°ƒï¼Œç”±è®¡æ—¶å™¨æ’å®šçš„å›è°ƒ å’Œ setFidate()); èŠ‚ç‚¹å°†åœ¨é€‚å½“æ—¶é˜»æ­¢æ­¤å¤„ã€‚
å‹¾é€‰: setEffite() å›è°ƒåœ¨æ­¤å¤„è¢«è°ƒç”¨ã€‚
å…³é—­çš„å›è°ƒå‡½æ•°ï¼šä¸€äº›å…³é—­çš„å›è°ƒå‡½æ•°ï¼Œå¦‚ï¼šsocket.on('close', ...)ã€‚

### Node çš„å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡

ä»ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„Tick, Node çš„äº‹ä»¶å¾ªç¯ä¼šæ›´åŠ çš„å¤æ‚,

å®ä»»åŠ¡: setTimeout, setInterval, IOäº‹ä»¶, setImmediate, close äº‹ä»¶
å¾®ä»»åŠ¡: Promiseçš„then å›è°ƒ, process.nextTick, queueMicrotask

å¾®ä»»åŠ¡é˜Ÿåˆ—è¿˜åˆ†ä¸º
  next tick queue: process.nextTick
  other queue: Promise.thenå›è°ƒ, queueMicrotask

å®ä»»åŠ¡é˜Ÿåˆ—:
  timer queue: setTimout setInterval
  poll queue: IO äº‹ä»¶
  check queue: setImmediate
  close queue: close äº‹ä»¶


ç›¸å…³é¢˜ç›®åˆ†æ
```js
async function async1() {
  // åŒæ­¥ä»£ç è¾“å‡º 2
  console.log('async1 start');
  // å¾®ä»»åŠ¡ 2
  await async2()
  // 8
  console.log('async1 end');
}

async function async2() {
  // åŒæ­¥ä»£ç  3
  console.log('async2');
}

// åŒæ­¥ä»£ç  1
console.log('scriptstart');

// å®ä»»åŠ¡ 1
setTimeout(function () {
  // 10
  console.log('setTimout0');
}, 0)

// è¿™é‡Œçš„å®ä»»åŠ¡ä¹Ÿè¦åŒºåˆ†æ”¾å…¥ äº‹ä»¶é˜Ÿåˆ—çš„å…ˆåé¡ºåº
// å®ä»»åŠ¡ 2 300ms æ—¶é—´åˆ°äº†ä¹‹åæ‰æ”¾å…¥ äº‹ä»¶é˜Ÿåˆ—ä¸­
setTimeout(function () {
  // 12
  console.log('setTimout1');
}, 300)

// å®ä»»åŠ¡3
// 11 è¿™é‡Œçš„ setImmediate ä¸ç”¨ç­‰æ—¶é—´å°±æ”¾å…¥äº† äº‹ä»¶é˜Ÿåˆ—ä¸­å› æ­¤æ¯”ä¸Šé¢çš„ setTimout å…ˆè¾“å‡º
setImmediate(() => console.log('seImmediate'))

// å¾®ä»»åŠ¡ 1 -> ç¬¬å…­ä¸ªè¾“å‡º 7
process.nextTick(() => console.log('nextTick2'))
// æ‰§è¡ŒåŒæ­¥ä»£ç 
async1()

new Promise(function (resolve) {
  // åŒæ­¥ä»£ç  4
  console.log('promise1');
  resolve()
  // åŒæ­¥ä»£ç  5
  console.log('promise2');
}).then(function () {
  // å¾®ä»»åŠ¡ 3
  // 9
  console.log('promise3');
})
// åŒæ­¥ä»£ç  6
console.log('script end');

```

