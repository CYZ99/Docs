# DNS 域名解析协议

## DNS 提供的服务

将域名转化为 成路由器可以识别的有层次结构的IP地址的应用层协议.(Domain Name System)
### DNS 组成

1. 一个由分层的服务器实现的分层的数据库
2. 一个使得主机能够查询分布式数据库的应用层协议.
    DNS 协议运行在UDP之上使用53端口.
    DNS 也是基于 客户端-服务器端的通信模型.

### 简单的通信过程

1. 用户主机上运行着DNS应用的客户端
2. 浏览器从URL中提取出 主机名 www.baidu.com, 并将主机名发送给 DNS 应用的客户端
3. DNS客户端先通过本地hosts文件查找对应的IP地址
4. 如果上一步没找到. DNS 客户端会向DNS服务器端发送一个请求,报文携带了主机名
5. DNS 客户端最后会接收到一份响应报文包含了 主机名相互映射的 IP地址
6. 一旦浏览器收到来自DNS的IP地址,能够向位于该地址的80端口的HTTP服务器进程发起一个HTTP请求

### 分布式,层次的数据库

DNS 使用了大量的 DNS 服务器,以一定的层次结构组织,并分布在全世界各地.
主要有三种类型的 DNS 服务器, 根DNS服务器, 顶级域服务器 (TLD), 权威服务器

![image-20230427200140594](https://cyzblog-1305365553.cos.ap-guangzhou.myqcloud.com/image-20230427200140594.png)

**根 DNS 服务器**

	1. 直接响应对根区域中的此资源记录的请求

	2.将请求转发到所请求 TLD 的适当名称服务器

**TLD 顶级域服务器**

	1.顶级域服务器,通常有 com, org, net, edu 和所有的国家的顶级域.

	2.顶级域服务器,提供了它的下一级,也就是 权威 DNS 服务器的IP地址.
**权威服务器**
>权威DNS是经过上一级授权对域名进行解析的服务器，同时它可以把解析授权转授给其他人，如com顶级服务器可以授权 dns.com 这个域名的的权威服务器为 cyz.com 同时 cyz.com 还可以把授权转授给 doc.cyz.com，这样 doc.cyz.com 就成了 cyz.com 实际上的权威服务器了。

**本地 DNS 服务器**

在通过浏览器缓存及host文件都无法解析域名的情况下，OS会将这个域名发送给计算机网络配置中DNS对应的地址（LDNS），即本地区的域名服务器。这个DNS通常都提供给你本地互联网接入的一个DNS解析服务，假如是在学校接入的互联网，那么这个本地区的域名服务器基本上是在学校中；如果是在小区接入的互联网，那么这个本地区的域名服务器就是提供给你接入互联网的应用服务上，也就是电信或联通。
--《深入分析java web 技术内幕》 许令波著

## DNS的查询方式和过程

### 迭代查询

**迭代查询，DNS 服务器会向客户机提供其他能够解析查询请求的DNS 服务器地址，当客户机发送查询请求时，DNS 服务器并不直接回复查询结果，而是告诉客户机另一台DNS 服务器地址，客户机再向这台DNS 服务器提交请求，依次循环直到返回查询的结果**


gaia.cs.umass.edu DNS 服务解析时是从右向左进行查询的 .
1.  请求主机的 DNS 应用客户端在本地没有缓存的情况下会向
2.  本地 DNS 服务器进行查询,  -> DNS本地服务器查找本地缓存当没有缓存或者缓存过期时. 本地 DNS 服务器会向根 DNS 服务器发送一个 查询报文, 根 DNS 服务器.从右往左解析发现 .edu 后缀,
3.  直接返回给 本地服务器 负责 edu 的 TLD 的 IP 地址列表,
4.  本地服务器, 寻找合适的 TLD 服务器发送查询报文. 该 TLD 权威服务器, 是负责 dns.umass.edu,
5.  最后本地DNS 服务器 直接向 dns.umass.edu 重发查询报文 dns.umass.edu 用 gaia.cs.umass.edu 的IP地址进行响应.

![image.png](https://cdn.nlark.com/yuque/0/2023/png/27950320/1682508329569-0edf8006-ab98-4832-84a3-4c8eb33dfa5b.png?x-oss-process=image%2Fresize%2Cw_497%2Climit_0)

这里的查询方式: 请求主机向本地服务器的查询方式 是 递归查询, 另外三个 是迭代查询.
### 递归查询

**递归查询是一种DNS 服务器的查询模式，在该模式下DNS 服务器接收到客户机请求，必须使用一个准确的查询结果回复客户机。如果DNS 服务器本地没有存储查询DNS 信息，那么该服务器会询问其他服务器，并将返回的查询结果提交给客户机。**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/27950320/1682508355534-8af9fcb2-1313-4f80-a8c3-ab3c20e6cf2d.png?x-oss-process=image%2Fresize%2Cw_487%2Climit_0)

这里的每一步都是递归查询

### DNS缓存

在一个请求链中, 当某个DNS 服务器 接收到一个DNS 回答(包含主机名和IP地址映射) 他能将 映射存放于本地存储中, 当下一次请求有DNS客户端请求 相同的域名时,会先返回缓存的内容,不用再发送查询报文
本地 DNS 服务器也能缓存 顶级域 服务器的 IP 地址,因而绕过了查询链中的 根DNS 服务器.

注意: 由于主机和主机名 IP 地址间的映射并不是永久的 DNS 服务器过一段时间将丢弃缓存.